<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo - Sistema de Croqui</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, Helvetica, sans-serif;
}

:root {
    --azul: #0b3c88;
    --azul-escuro: #0a2d46;
    --cinza: #f2f2f2;
    --cinza-escuro: #e0e0e0;
    --borda: #dcdcdc;
    --verde: #27ae60;
    --vermelho: #e74c3c;
}

body {
    background: #f5f7fa;
    min-height: 100vh;
}

header {
    background: linear-gradient(90deg, var(--azul-escuro), var(--azul));
    color: #fff;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.logo {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo img {
    height: 50px;
}

.logo h1 {
    font-size: 20px;
    font-weight: bold;
}

.logout-btn {
    background: rgba(255,255,255,0.1);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s;
}

.logout-btn:hover {
    background: rgba(255,255,255,0.2);
}

main {
    padding: 30px;
    max-width: 1200px;
    margin: 0 auto;
}

#loginAdmin {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 70vh;
}

.login-box {
    width: 400px;
    border: 1px solid var(--borda);
    padding: 40px;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.login-box h2 {
    color: var(--azul);
    margin-bottom: 30px;
    text-align: center;
    font-size: 24px;
}

.login-box input {
    width: 100%;
    padding: 14px;
    margin-bottom: 20px;
    border: 1px solid var(--borda);
    border-radius: 8px;
    font-size: 16px;
}

.login-box input:focus {
    outline: none;
    border-color: var(--azul);
    box-shadow: 0 0 0 2px rgba(11, 60, 136, 0.2);
}

.login-box button {
    width: 100%;
    padding: 14px;
    background: var(--azul);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
}

.login-box button:hover {
    background: #0a2d46;
}

#painelAdmin {
    display: none;
}

.section {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.section h3 {
    color: var(--azul);
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--cinza);
    font-size: 20px;
}

.form-inline {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: flex-end;
}

.form-group {
    flex: 1;
    min-width: 200px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: bold;
}

.form-inline input {
    padding: 12px;
    border: 1px solid var(--borda);
    border-radius: 8px;
    width: 100%;
    font-size: 16px;
}

.form-inline button {
    padding: 12px 30px;
    background: var(--verde);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
}

.form-inline button:hover {
    background: #219653;
}

.tabela-container {
    overflow-x: auto;
    margin-top: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

table th, table td {
    border: 1px solid var(--borda);
    padding: 15px;
    text-align: left;
}

table th {
    background: var(--cinza);
    color: var(--azul);
    font-weight: bold;
}

table tr:hover {
    background: #f9f9f9;
}

table button {
    padding: 8px 16px;
    margin-right: 8px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: 0.3s;
}

.btn-editar {
    background: #3498db;
    color: white;
}

.btn-editar:hover {
    background: #2980b9;
}

.btn-excluir {
    background: var(--vermelho);
    color: white;
}

.btn-excluir:hover {
    background: #c0392b;
}

.estatisticas {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.estatistica-card {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    text-align: center;
}

.estatistica-valor {
    font-size: 36px;
    font-weight: bold;
    color: var(--azul);
    margin: 10px 0;
}

.estatistica-label {
    color: #666;
    font-size: 14px;
}

.message {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
    display: none;
}

.message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<div id="loginAdmin">
    <div class="login-box">
        <h2><i class="fas fa-lock"></i> Acesso Administrativo</h2>
        <input type="text" id="adminUser" placeholder="Usu√°rio administrador">
        <input type="password" id="adminPass" placeholder="Senha">
        <div class="message error" id="loginError">Usu√°rio ou senha incorretos!</div>
        <button onclick="loginAdmin()">Entrar</button>
        
        <div style="text-align: center; margin-top: 20px;">
            <a href="index.html" style="color: var(--azul); text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Voltar para p√°gina inicial
            </a>
        </div>
    </div>
</div>

<div id="painelAdmin">
    <header>
        <div class="logo">
            <img src="https://www.botucatu.sp.gov.br/public/admin/globalarq/uploads/images/S%C3%ADmbolos/terceiro_brasao.jpg">
            <h1>Painel Administrativo - Sistema de Croqui</h1>
        </div>
        <button class="logout-btn" onclick="logoutAdmin()">
            <i class="fas fa-sign-out-alt"></i> Sair
        </button>
    </header>

    <main>
        <div class="estatisticas">
            <div class="estatistica-card">
                <i class="fas fa-users" style="font-size: 24px; color: var(--azul);"></i>
                <div class="estatistica-valor" id="totalServidores">0</div>
                <div class="estatistica-label">Servidores Cadastrados</div>
            </div>
            <div class="estatistica-card">
                <i class="fas fa-file-alt" style="font-size: 24px; color: var(--azul);"></i>
                <div class="estatistica-valor" id="totalSolicitacoes">0</div>
                <div class="estatistica-label">Solicita√ß√µes Totais</div>
            </div>
            <div class="estatistica-card">
                <i class="fas fa-clock" style="font-size: 24px; color: #f39c12;"></i>
                <div class="estatistica-valor" id="pendentes">0</div>
                <div class="estatistica-label">Solicita√ß√µes Pendentes</div>
            </div>
        </div>

        <div class="section">
            <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Servidor</h3>
            <div class="message success" id="successMessage">Servidor cadastrado com sucesso!</div>
            <div class="form-inline">
                <div class="form-group">
                    <label>Nome do Servidor</label>
                    <input type="text" id="nomeServidor" placeholder="Nome completo">
                </div>
                <div class="form-group">
                    <label>RI (Registro Interno)</label>
                    <input type="text" id="riServidor" placeholder="N√∫mero do RI">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="senhaServidor" placeholder="Senha de acesso">
                </div>
                <button onclick="adicionarServidor()">
                    <i class="fas fa-plus"></i> Cadastrar
                </button>
            </div>
        </div>

        <div class="section">
            <h3><i class="fas fa-list"></i> Servidores Cadastrados</h3>
            <div class="tabela-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>RI</th>
                            <th>Senha</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaServidores">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h3><i class="fas fa-search"></i> Visualizar Solicita√ß√µes</h3>
            <div style="margin-bottom: 20px;">
                <button onclick="carregarTodasSolicitacoes()" style="background: var(--azul);">
                    <i class="fas fa-sync"></i> Atualizar Lista
                </button>
            </div>
            <div class="tabela-container">
                <table id="tabelaSolicitacoes">
                    <thead>
                        <tr>
                            <th>Protocolo</th>
                            <th>Tipo</th>
                            <th>Solicitante</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th>Servidor</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
const ADMIN_CREDENTIALS = {
    usuario: "vinicius.megetto",
    senha: "PMbtu2023"
};

document.addEventListener('DOMContentLoaded', function() {
    const adminLogado = sessionStorage.getItem('adminLogado');
    if (adminLogado === 'true') {
        document.getElementById('loginAdmin').style.display = 'none';
        document.getElementById('painelAdmin').style.display = 'block';
        carregarDados();
    }
});

async function loginAdmin() {
    const usuario = document.getElementById('adminUser').value;
    const senha = document.getElementById('adminPass').value;
    const errorMsg = document.getElementById('loginError');

    // Login local (sem chamada de API para localhost)
    if (usuario === ADMIN_CREDENTIALS.usuario && senha === ADMIN_CREDENTIALS.senha) {
        sessionStorage.setItem('adminLogado', 'true');
        document.getElementById('loginAdmin').style.display = 'none';
        document.getElementById('painelAdmin').style.display = 'block';
        carregarDados();
    } else {
        errorMsg.textContent = 'Credenciais inv√°lidas';
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 3000);
    }
}

function logoutAdmin() {
    sessionStorage.removeItem('adminLogado');
    window.location.href = 'index.html';
}

async function carregarDados() {
    await carregarServidores();
    await carregarEstatisticas();
    await carregarTodasSolicitacoes();
}

async function carregarServidores() {
    try {
        // ‚úÖ CORRE√á√ÉO: Caminho relativo em vez de localhost:3000
        const response = await fetch('/api/servidores');
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.getElementById('tabelaServidores');
            tbody.innerHTML = '';

            result.dados.forEach((servidor, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${servidor.nome || 'N√£o informado'}</td>
                    <td>${servidor.ri}</td>
                    <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                    <td>
                        <button class="btn-editar" onclick="editarServidor('${servidor.id}', '${servidor.nome}', '${servidor.ri}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-excluir" onclick="excluirServidor('${servidor.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalServidores').textContent = result.dados.length;
        }
    } catch (error) {
        console.error('Erro ao carregar servidores:', error);
        document.getElementById('tabelaServidores').innerHTML = `
            <tr><td colspan="4" style="text-align:center;color:#666;padding:40px;">
                <i class="fas fa-exclamation-triangle"></i> Erro ao carregar servidores.
                <br><small>Verifique se a API est√° funcionando.</small>
            </td></tr>`;
    }
}

async function carregarEstatisticas() {
    try {
        // ‚úÖ CORRE√á√ÉO: Caminho relativo
        const response = await fetch('/api/solicitacoes');
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('totalSolicitacoes').textContent = result.total || result.dados.length;
            
            const pendentes = result.dados.filter(s => s.status === 'pendente').length;
            document.getElementById('pendentes').textContent = pendentes;
        }
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
        document.getElementById('totalSolicitacoes').textContent = '0';
        document.getElementById('pendentes').textContent = '0';
    }
}

async function carregarTodasSolicitacoes() {
    try {
        // ‚úÖ CORRE√á√ÉO: Caminho relativo
        const response = await fetch('/api/solicitacoes');
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.querySelector('#tabelaSolicitacoes tbody');
            tbody.innerHTML = '';

            result.dados.sort((a, b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));

            result.dados.forEach(solicitacao => {
                const tr = document.createElement('tr');
                
                let statusClass = '';
                let statusIcon = '';
                
                switch(solicitacao.status) {
                    case 'pendente':
                        statusClass = 'pendente';
                        statusIcon = '‚è≥';
                        break;
                    case 'em_analise':
                        statusClass = 'analise';
                        statusIcon = 'üîç';
                        break;
                    case 'atendida':
                        statusClass = 'atendida';
                        statusIcon = solicitacao.resultado === 'deferido' ? '‚úÖ' : '‚ùå';
                        break;
                }

                tr.innerHTML = `
                    <td><strong>${solicitacao.numero || solicitacao.id}</strong></td>
                    <td>${solicitacao.tipo}</td>
                    <td>${solicitacao.nome}</td>
                    <td>${new Date(solicitacao.dataCriacao).toLocaleDateString('pt-BR')}</td>
                    <td><span class="status ${statusClass}">${statusIcon} ${solicitacao.status}</span></td>
                    <td>${solicitacao.servidorResponsavel || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar solicita√ß√µes:', error);
        document.querySelector('#tabelaSolicitacoes tbody').innerHTML = `
            <tr><td colspan="6" style="text-align:center;color:#666;padding:40px;">
                <i class="fas fa-exclamation-triangle"></i> Erro ao carregar solicita√ß√µes.
            </td></tr>`;
    }
}

async function adicionarServidor() {
    const nome = document.getElementById('nomeServidor').value.trim();
    const ri = document.getElementById('riServidor').value.trim();
    const senha = document.getElementById('senhaServidor').value.trim();
    const successMsg = document.getElementById('successMessage');

    if (!nome || !ri || !senha) {
        alert('Por favor, preencha todos os campos.');
        return;
    }

    try {
        // ‚úÖ CORRE√á√ÉO: Caminho relativo
        const response = await fetch('/api/servidores', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nome, ri, senha })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('nomeServidor').value = '';
            document.getElementById('riServidor').value = '';
            document.getElementById('senhaServidor').value = '';

            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);

            await carregarServidores();
        } else {
            alert('Erro ao cadastrar servidor: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro de conex√£o com o servidor.');
        console.error(error);
    }
}

async function editarServidor(id, nomeAtual, riAtual) {
    const novoNome = prompt('Novo nome do servidor:', nomeAtual);
    if (novoNome === null) return;

    const novoRI = prompt('Novo RI:', riAtual);
    if (novoRI === null) return;

    const novaSenha = prompt('Nova senha (deixe em branco para manter a atual):', '');
    
    const dados = { nome: novoNome, ri: novoRI };
    if (novaSenha) {
        dados.senha = novaSenha;
    }

    try {
        // ‚úÖ CORRE√á√ÉO: Caminho relativo
        const response = await fetch(`/api/servidores/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Servidor atualizado com sucesso!');
            await carregarServidores();
        } else {
            alert('Erro ao atualizar: ' + result.error);
        }
    } catch (error) {
        alert('Erro de conex√£o.');
        console.error(error);
    }
}

async function excluirServidor(id) {
    if (!confirm('Tem certeza que deseja excluir este servidor?')) {
        return;
    }

    try {
        // ‚úÖ CORRE√á√ÉO: Caminho relativo
        const response = await fetch(`/api/servidores/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Servidor exclu√≠do com sucesso!');
            await carregarServidores();
        } else {
            alert('Erro ao excluir: ' + result.error);
        }
    } catch (error) {
        alert('Erro de conex√£o.');
        console.error(error);
    }
}

const style = document.createElement('style');
style.textContent = `
    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .status.pendente {
        background: #fff3cd;
        color: #856404;
    }
    .status.analise {
        background: #d1ecf1;
        color: #0c5460;
    }
    .status.atendida {
        background: #d4edda;
        color: #155724;
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>
