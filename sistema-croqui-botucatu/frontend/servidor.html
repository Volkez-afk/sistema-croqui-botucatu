<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Servidor – Solicitações de Croqui</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, Helvetica, sans-serif;
}

body {
    background: #f4f6f8;
    display: flex;
    height: 100vh;
}

.sidebar {
    width: 280px;
    background: linear-gradient(180deg, #0b3c5d, #0a2d46);
    color: #fff;
    padding: 20px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.sidebar h2 {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255,255,255,0.1);
}

.menu-item {
    padding: 14px 20px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    background: rgba(255,255,255,0.08);
    transition: 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.menu-item:hover {
    background: rgba(255,255,255,0.15);
}

.menu-item.active {
    background: rgba(255,255,255,0.25);
    font-weight: bold;
}

.content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.card {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    margin-bottom: 25px;
}

.card h3 {
    margin-top: 0;
    color: #0b3c5d;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
    margin-bottom: 20px;
}

.lista-solicitacoes {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.solicitacao-item {
    padding: 16px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    background: #f9f9f9;
}

.solicitacao-item:hover {
    background: #eef5ff;
    border-color: #0b3c5d;
    transform: translateX(5px);
}

.solicitacao-item .numero {
    font-weight: bold;
    color: #0b3c5d;
}

.solicitacao-item .tipo {
    color: #666;
    font-size: 14px;
}

.solicitacao-item .data {
    font-size: 12px;
    color: #888;
    margin-top: 5px;
}

.detalhes-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.info-group {
    display: flex;
    margin-bottom: 10px;
}

.info-group strong {
    width: 200px;
    color: #333;
}

.info-group span {
    flex: 1;
    color: #555;
}

.acoes-container {
    display: flex;
    gap: 15px;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    font-size: 14px;
}

.btn-primary {
    background: #0b3c5d;
    color: #fff;
}

.btn-primary:hover {
    background: #145374;
}

.btn-danger {
    background: #d32f2f;
    color: #fff;
}

.btn-danger:hover {
    background: #b71c1c;
}

.btn-secondary {
    background: #6c757d;
    color: #fff;
}

.btn-secondary:hover {
    background: #545b62;
}

.form-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #0b3c5d;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

textarea, input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

textarea {
    min-height: 100px;
    resize: vertical;
}

.hidden {
    display: none;
}

.header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #ddd;
}

.header-info h1 {
    color: #0b3c5d;
    font-size: 24px;
}

.servidor-info {
    background: #e3f2fd;
    padding: 10px 15px;
    border-radius: 6px;
    color: #0b3c5d;
    font-weight: bold;
}

.logout-btn {
    padding: 8px 16px;
    background: transparent;
    color: #0b3c5d;
    border: 1px solid #0b3c5d;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.logout-btn:hover {
    background: #0b3c5d;
    color: white;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<div class="sidebar">
    <h2><i class="fas fa-user-tie"></i> Painel do Servidor</h2>
    
    <div class="menu-item active" onclick="abrirAba('pendentes', this)">
        <i class="fas fa-clock"></i> Solicitações Pendentes
    </div>
    
    <div class="menu-item" onclick="abrirAba('analise', this)">
        <i class="fas fa-search"></i> Em Análise
    </div>
    
    <div class="menu-item" onclick="abrirAba('atendidas', this)">
        <i class="fas fa-check-circle"></i> Atendidas
    </div>
    
    <div class="menu-item" onclick="abrirAba('todas', this)">
        <i class="fas fa-list"></i> Todas as Solicitações
    </div>
</div>

<div class="content">
    <div class="header-info">
        <h1>Sistema de Gerenciamento de Croquis</h1>
        <div>
            <span class="servidor-info" id="nomeServidor"></span>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </div>

    <div id="listaContainer" class="card">
        <h3 id="tituloLista">Solicitações Pendentes</h3>
        <div class="lista-solicitacoes" id="listaSolicitacoes">
            <!-- Solicitações serão carregadas via JavaScript -->
        </div>
    </div>

    <div id="detalhesContainer" class="card hidden">
        <h3 id="tituloDetalhes">Detalhes da Solicitação</h3>
        
        <div class="detalhes-container" id="detalhesConteudo">
            <!-- Conteúdo será preenchido via JavaScript -->
        </div>
        
        <div id="acoesPendentes" class="acoes-container">
            <button class="btn btn-primary" onclick="aceitarSolicitacao()">
                <i class="fas fa-check"></i> Aceitar para Análise
            </button>
            <button class="btn btn-secondary" onclick="voltarParaLista()">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>
        
        <div id="acoesAnalise" class="acoes-container hidden">
            <div class="form-section">
                <h4><i class="fas fa-file-pdf"></i> Finalizar Solicitação</h4>
                
                <div id="opcoesFinalizacao">
                    <button class="btn btn-primary" onclick="mostrarOpcao('deferir')">
                        <i class="fas fa-check-circle"></i> Deferir
                    </button>
                    <button class="btn btn-danger" onclick="mostrarOpcao('indeferir')">
                        <i class="fas fa-times-circle"></i> Indeferir
                    </button>
                </div>
                
                <div id="formDeferir" class="form-section hidden">
                    <div class="form-group">
                        <label><i class="fas fa-file-upload"></i> Anexar Croqui Aprovado (PDF)</label>
                        <input type="file" id="arquivoDeferir" accept=".pdf">
                    </div>
                    <button class="btn btn-primary" onclick="finalizarSolicitacao('deferido')">
                        <i class="fas fa-paper-plane"></i> Enviar Croqui
                    </button>
                </div>
                
                <div id="formIndeferir" class="form-section hidden">
                    <div class="form-group">
                        <label><i class="fas fa-comment"></i> Motivo do Indeferimento</label>
                        <textarea id="motivoIndeferir" placeholder="Descreva o motivo do indeferimento..."></textarea>
                    </div>
                    <button class="btn btn-danger" onclick="finalizarSolicitacao('indeferido')">
                        <i class="fas fa-paper-plane"></i> Enviar Indeferimento
                    </button>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="voltarParaLista()">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
        </div>
    </div>
</div>

<script>
let abaAtual = 'pendentes';
let solicitacaoSelecionada = null;
let servidorLogado = null;

document.addEventListener('DOMContentLoaded', function() {
    servidorLogado = JSON.parse(sessionStorage.getItem('servidorLogado'));
    
    if (!servidorLogado) {
        window.location.href = 'login-servidor.html';
        return;
    }
    
    document.getElementById('nomeServidor').textContent = servidorLogado.nome;
    carregarSolicitacoes();
});

async function carregarSolicitacoes() {
    let url = '/api/solicitacoes';
    
    if (abaAtual === 'pendentes') {
        url += '?status=pendente';
    } else if (abaAtual === 'analise') {
        url += '?status=em_analise';
    } else if (abaAtual === 'atendidas') {
        url += '?status=atendida';
    }
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            renderizarLista(result.dados);
        } else {
            console.error('Erro ao carregar:', result.error);
            document.getElementById('listaSolicitacoes').innerHTML = 
                `<p style="text-align:center;color:#666;">Erro ao carregar solicitações.</p>`;
        }
    } catch (error) {
        console.error('Falha na conexão com a API:', error);
        document.getElementById('listaSolicitacoes').innerHTML = 
            `<p style="text-align:center;color:#666;">Erro de conexão com o servidor.</p>`;
    }
}

function renderizarLista(solicitacoes) {
    const listaContainer = document.getElementById('listaSolicitacoes');
    listaContainer.innerHTML = '';
    
    const tituloMap = {
        'pendentes': 'Solicitações Pendentes',
        'analise': 'Solicitações em Análise',
        'atendidas': 'Solicitações Atendidas',
        'todas': 'Todas as Solicitações'
    };
    
    document.getElementById('tituloLista').textContent = tituloMap[abaAtual];
    
    if (solicitacoes.length === 0) {
        listaContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 20px;"></i>
                <p>Nenhuma solicitação encontrada nesta categoria.</p>
            </div>
        `;
        return;
    }
    
    solicitacoes.forEach(solicitacao => {
        const item = document.createElement('div');
        item.className = 'solicitacao-item';
        item.onclick = () => mostrarDetalhes(solicitacao);
        
        const tipoClass = solicitacao.tipo === 'Croqui Oficial' ? 'oficial' : 'consulta';
        const statusClass = solicitacao.status === 'pendente' ? 'pendente' : 
                          solicitacao.status === 'em_analise' ? 'analise' : 'atendida';
        
        item.innerHTML = `
            <div class="numero">Solicitação ${solicitacao.numero}</div>
            <div class="tipo">
                <span class="badge ${tipoClass}">${solicitacao.tipo}</span>
                <span class="badge ${statusClass}">${solicitacao.status === 'pendente' ? 'Pendente' : 
                    solicitacao.status === 'em_analise' ? 'Em Análise' : 'Atendida'}</span>
            </div>
            <div class="data">
                Recebida em: ${new Date(solicitacao.dataCriacao).toLocaleDateString('pt-BR')}
            </div>
        `;
        
        listaContainer.appendChild(item);
    });
}

function abrirAba(aba, elemento) {
    abaAtual = aba;
    
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    elemento.classList.add('active');
    
    document.getElementById('listaContainer').classList.remove('hidden');
    document.getElementById('detalhesContainer').classList.add('hidden');
    
    carregarSolicitacoes();
}

function mostrarDetalhes(solicitacao) {
    solicitacaoSelecionada = solicitacao;
    
    document.getElementById('listaContainer').classList.add('hidden');
    document.getElementById('detalhesContainer').classList.remove('hidden');
    
    document.getElementById('tituloDetalhes').textContent = 
        `Solicitação ${solicitacao.numero} - ${solicitacao.tipo}`;
    
    const detalhes = document.getElementById('detalhesConteudo');
    
    // Montar link para o PDF se existir
    let pdfLink = '';
    if (solicitacao.arquivoAnexo && solicitacao.arquivoAnexo.caminho) {
        pdfLink = `
            <div class="info-group">
                <strong>Comprovação de Posse:</strong>
                <div style="background: #e8f4fd; padding: 10px; border-radius: 6px; margin-top: 5px;">
                    <i class="fas fa-file-pdf" style="color: #d32f2f;"></i>
                    <strong>${solicitacao.arquivoAnexo.nomeOriginal}</strong><br>
                    <small>Tamanho: ${(solicitacao.arquivoAnexo.tamanho / 1024).toFixed(2)} KB</small><br>
                    <a href="${solicitacao.arquivoAnexo.caminho}" target="_blank" style="color: #0b3c5d; text-decoration: underline;">
                        <i class="fas fa-download"></i> Baixar PDF
                    </a>
                </div>
            </div>
        `;
    }
    
    detalhes.innerHTML = `
        <div class="info-group">
            <strong>Status:</strong>
            <span style="color: ${solicitacao.status === 'pendente' ? '#f39c12' : 
                         solicitacao.status === 'em_analise' ? '#3498db' : '#27ae60'}; font-weight: bold;">
                ${solicitacao.status === 'pendente' ? '⏳ Pendente' : 
                  solicitacao.status === 'em_analise' ? '🔍 Em Análise' : '✅ Atendida'}
            </span>
        </div>
        <div class="info-group">
            <strong>Data de Recebimento:</strong>
            <span>${new Date(solicitacao.dataCriacao).toLocaleDateString('pt-BR')}</span>
        </div>
        <div class="info-group">
            <strong>Nome do Solicitante:</strong>
            <span>${solicitacao.nome}</span>
        </div>
        <div class="info-group">
            <strong>CPF:</strong>
            <span>${solicitacao.cpf || 'Não informado'}</span>
        </div>
        <div class="info-group">
            <strong>IPTU:</strong>
            <span>${solicitacao.iptu}</span>
        </div>
        <div class="info-group">
            <strong>Endereço:</strong>
            <span>${solicitacao.endereco}, ${solicitacao.numeroImovel || 'S/N'}</span>
        </div>
        <div class="info-group">
            <strong>Bairro:</strong>
            <span>${solicitacao.bairro}</span>
        </div>
        <div class="info-group">
            <strong>Quadra/Lote:</strong>
            <span>${solicitacao.quadra} / ${solicitacao.lote}</span>
        </div>
        ${pdfLink}
        ${solicitacao.servidorResponsavel ? `
        <div class="info-group">
            <strong>Servidor Responsável:</strong>
            <span>${solicitacao.servidorResponsavel}</span>
        </div>
        ` : ''}
        ${solicitacao.resultado ? `
        <div class="info-group">
            <strong>Resultado:</strong>
            <span style="color: ${solicitacao.resultado === 'deferido' ? '#27ae60' : '#e74c3c'};">
                ${solicitacao.resultado === 'deferido' ? '✅ Deferido' : '❌ Indeferido'}
            </span>
        </div>
        ` : ''}
        ${solicitacao.motivo ? `
        <div class="info-group">
            <strong>Motivo:</strong>
            <span>${solicitacao.motivo}</span>
        </div>
        ` : ''}
    `;
    
    // Mostrar ações apropriadas
    if (solicitacao.status === 'pendente') {
        document.getElementById('acoesPendentes').classList.remove('hidden');
        document.getElementById('acoesAnalise').classList.add('hidden');
    } else if (solicitacao.status === 'em_analise') {
        document.getElementById('acoesPendentes').classList.add('hidden');
        document.getElementById('acoesAnalise').classList.remove('hidden');
        document.getElementById('opcoesFinalizacao').classList.remove('hidden');
        document.getElementById('formDeferir').classList.add('hidden');
        document.getElementById('formIndeferir').classList.add('hidden');
    } else {
        document.getElementById('acoesPendentes').classList.add('hidden');
        document.getElementById('acoesAnalise').classlist.add('hidden');
    }
}

async function aceitarSolicitacao() {
    if (!solicitacaoSelecionada) return;
    
    try {
        const response = await fetch(`/api/solicitacoes/${solicitacaoSelecionada.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'em_analise',
                servidorResponsavel: servidorLogado.nome
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`✅ Solicitação ${solicitacaoSelecionada.numero} aceita para análise!`);
            abrirAba('analise', document.querySelector('.menu-item:nth-child(2)'));
        } else {
            alert('❌ Erro ao aceitar solicitação: ' + result.error);
        }
    } catch (error) {
        alert('❌ Erro de conexão com o servidor.');
        console.error(error);
    }
}

function mostrarOpcao(tipo) {
    document.getElementById('opcoesFinalizacao').classList.add('hidden');
    
    if (tipo === 'deferir') {
        document.getElementById('formDeferir').classList.remove('hidden');
    } else {
        document.getElementById('formIndeferir').classList.remove('hidden');
    }
}

async function finalizarSolicitacao(resultado) {
    if (!solicitacaoSelecionada) return;
    
    let dadosAtualizacao = {
        status: 'atendida',
        resultado: resultado === 'deferido' ? 'deferido' : 'indeferido'
    };
    
    if (resultado === 'indeferido') {
        const motivo = document.getElementById('motivoIndeferir').value;
        if (!motivo.trim()) {
            alert('Por favor, informe o motivo do indeferimento.');
            return;
        }
        dadosAtualizacao.motivo = motivo;
    }
    
    try {
        const response = await fetch(`/api/solicitacoes/${solicitacaoSelecionada.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dadosAtualizacao)
        });
        
        const result = await response.json();
        
        if (result.success) {
            const mensagem = resultado === 'deferido' 
                ? '✅ Croqui deferido e enviado com sucesso!' 
                : '✅ Solicitação indeferida com sucesso!';
            
            alert(mensagem);
            abrirAba('atendidas', document.querySelector('.menu-item:nth-child(3)'));
        } else {
            alert('❌ Erro ao finalizar solicitação: ' + result.error);
        }
    } catch (error) {
        alert('❌ Erro de conexão com o servidor.');
        console.error(error);
    }
}

function voltarParaLista() {
    document.getElementById('listaContainer').classList.remove('hidden');
    document.getElementById('detalhesContainer').classList.add('hidden');
}

function logout() {
    sessionStorage.removeItem('servidorLogado');
    window.location.href = 'index.html';
}

// Estilos para badges
const style = document.createElement('style');
style.textContent = `
    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 5px;
    }
    .badge.oficial { background: #3498db; color: white; }
    .badge.consulta { background: #9b59b6; color: white; }
    .badge.pendente { background: #f39c12; color: white; }
    .badge.analise { background: #3498db; color: white; }
    .badge.atendida { background: #27ae60; color: white; }
`;
document.head.appendChild(style);
</script>
</body>
</html>